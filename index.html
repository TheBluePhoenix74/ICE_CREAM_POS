<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ice Cream POS</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- === CSS STYLES SECTION START === -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom font import for aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* Light background */
        }
        /* Custom scrollbar for better visual appeal */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #a0a0a0;
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #e0e0e0;
        }
        /* Ice Cream Theme Colors */
        .color-primary { background-color: #ffb8c2; } /* Soft Pink (Strawberry) */
        .color-secondary { background-color: #65a30d; } /* Lime Green (Mint/Pistachio) */
        .text-primary { color: #8e44ad; } /* Deep Purple */
        .border-primary { border-color: #ffb8c2; }
        
        /* Ensure HTML and Body use full height of viewport */
        html, body {
            height: 100%;
        }
    </style>
    <!-- === CSS STYLES SECTION END === -->
</head>
<body class="min-h-screen flex flex-col antialiased">

    <!-- === HTML STRUCTURE SECTION START === -->

    <!-- Header -->
    <header class="shadow-md p-4 bg-white sticky top-0 z-10">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <h1 class="text-3xl font-extrabold text-primary">Sweet Scoops POS</h1>
            
            <!-- Real-time Clock and Date Display -->
            <div id="date-time-display" class="text-sm font-medium text-gray-700 text-center flex-grow mx-4">
                <!-- Clock will be updated by JS -->
                <span class="text-lg font-bold text-gray-800">00:00:00 AM</span>
                <span class="text-xs text-gray-500">Loading Date...</span>
            </div>

            <div id="auth-status" class="text-sm font-medium text-gray-600 flex-shrink-0">
                <span id="user-id-display" class="hidden">User: <span class="font-mono text-xs p-1 rounded bg-gray-100"></span></span>
                <span id="loading-auth" class="text-yellow-600">Loading...</span>
            </div>
        </div>
    </header>

    <!-- Main POS Layout -->
    <main class="flex-grow max-w-7xl mx-auto w-full p-4 grid lg:grid-cols-3 gap-6">

        <!-- Column 1: Categories and Menu Items -->
        <section class="lg:col-span-2 flex flex-col space-y-4 h-[calc(100vh-8rem)]">
            <!-- Category Tabs -->
            <div id="category-tabs" class="flex flex-wrap gap-2 p-2 rounded-xl shadow-inner bg-white flex-shrink-0">
                <!-- Buttons will be rendered here -->
            </div>

            <!-- Menu Items Display -->
            <div id="menu-items" class="grid grid-cols-2 sm:grid-cols-3 gap-4 flex-grow custom-scroll overflow-y-auto p-2 bg-white rounded-xl shadow-lg">
                <!-- Menu items will be rendered here -->
            </div>
        </section>

        <!-- Column 2: Order Summary (Cart) -->
        <section class="lg:col-span-1 flex flex-col bg-white rounded-xl shadow-lg p-4 h-[calc(100vh-8rem)]">
            <!-- Title with Order Number -->
            <h2 class="text-2xl font-bold text-primary mb-4 border-b pb-2 flex-shrink-0 flex justify-between items-center">
                <span>Current Order</span>
                <span id="order-number-display" class="text-lg font-extrabold text-gray-500 bg-gray-100 p-1 rounded">Order #001</span>
            </h2>

            <!-- Cart Items List -->
            <div id="cart-items-list" class="flex-grow custom-scroll overflow-y-auto space-y-3 pr-2 mb-4">
                <!-- Cart items will be rendered here -->
            </div>

            <!-- Total Summary -->
            <div id="cart-summary" class="border-t pt-4 space-y-2 flex-shrink-0">
                <div class="flex justify-between items-center text-lg">
                    <span class="font-medium text-gray-700">Subtotal:</span>
                    <span id="subtotal-amount" class="font-semibold text-gray-700">$0.00</span>
                </div>
                <div class="flex justify-between items-center text-2xl font-extrabold color-primary rounded-lg p-2 shadow-inner">
                    <span class="text-gray-800">TOTAL:</span>
                    <span id="total-amount" class="text-gray-800">$0.00</span>
                </div>
                
                <button onclick="clearOrder()" class="w-full py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl shadow-lg transition duration-150 transform hover:scale-[1.01] disabled:opacity-50" disabled id="clear-order-btn">
                    Clear Order
                </button>
                <button onclick="checkout()" class="w-full py-3 color-secondary hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition duration-150 transform hover:scale-[1.01] disabled:opacity-50" disabled id="checkout-btn">
                    Process Payment (Checkout)
                </button>
                <div id="message-box" class="mt-4 hidden p-3 rounded-lg text-center font-semibold transition-opacity duration-300"></div>
            </div>
        </section>
    </main>

    <!-- Modal for Flavor Selection (Hidden by default) -->
    <div id="flavor-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-20 hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-11/12 max-w-2xl transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-primary mb-4">Select Flavors</h3>
            <p id="flavor-modal-item-name" class="text-lg font-semibold text-gray-700 mb-4"></p>
            
            <!-- Scoop Selection Indicators -->
            <div id="scoop-indicators" class="flex flex-wrap gap-3 p-3 bg-gray-50 rounded-lg mb-4 border border-gray-200">
                <!-- Scoop indicator buttons will be inserted here -->
            </div>

            <!-- Single Flavor Grid Container - Now includes action buttons at the end -->
            <div id="single-flavor-grid" class="grid grid-cols-4 sm:grid-cols-6 gap-3 custom-scroll overflow-y-auto max-h-96 p-2 border-b pb-4">
                <!-- Flavor and Action buttons will be inserted here (dynamically) -->
            </div>
            
            <p id="flavor-error" class="text-red-500 text-sm mt-3 hidden"></p>
        </div>
    </div>
    
    <!-- Modal for Topping Selection (New) -->
    <div id="topping-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-20 hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-11/12 max-w-xl transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-primary mb-4">Add Toppings</h3>
            <p id="topping-modal-item-name" class="text-lg font-semibold text-gray-700 mb-4"></p>
            
            <!-- Topping Selection Grid -->
            <div id="topping-selection-grid" class="grid grid-cols-3 gap-3 custom-scroll overflow-y-auto max-h-80 p-2 border-b pb-4">
                <!-- Topping buttons will be inserted here -->
            </div>
            
            <p class="text-sm text-gray-500 mt-4">Select multiple toppings.</p>

            <div class="mt-4 flex justify-end space-x-3">
                <button onclick="closeToppingModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 font-medium transition duration-150">Cancel</button>
                <button onclick="confirmToppings()" class="px-4 py-2 color-secondary text-white rounded-lg hover:bg-green-700 font-bold transition duration-150">Save Toppings</button>
            </div>
        </div>
    </div>
    <!-- === HTML STRUCTURE SECTION END === -->


    <!-- === JAVASCRIPT LOGIC SECTION START === -->

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and App Variables
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pos-app';
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Global Constants
        const TOPPING_PRICE = 0.50; // Price per topping

        // Global State for Modals
        let itemPendingFlavor = null; // Stores the item object waiting for flavor confirmation
        let pendingFlavors = [];      // Array to store selected flavors for the current item
        let currentScoopIndex = 0;    // Index of the scoop currently being flavored (0-indexed)
        
        let itemPendingToppingsId = null; // Stores the ID of the item currently receiving toppings
        let pendingToppings = [];         // Array to store selected toppings for the current item


        // Set log level for debugging Firestore issues
        setLogLevel('debug');

        // Menu and Flavors Data
        const MENU = {
            "scoops": [
                { name: "Single Scoop - Waffle Cone", price: 4.00, scoops: 1, isFlavorRequired: true },
                { name: "Double Scoop - Waffle Cone", price: 6.00, scoops: 2, isFlavorRequired: true },
                { name: "Triple Scoop - Waffle Cone", price: 7.50, scoops: 3, isFlavorRequired: true },
                
                { name: "Single Scoop - Cup", price: 3.50, scoops: 1, isFlavorRequired: true },
                { name: "Double Scoop - Cup", price: 5.50, scoops: 2, isFlavorRequired: true },
                { name: "Triple Scoop - Cup", price: 7.00, scoops: 3, isFlavorRequired: true },

                { name: "Banana Split", price: 8.00, scoops: 3, isFlavorRequired: true },
                // RENAMED AND MODIFIED POP ITEMS - NOW REQUIRE FLAVOR SELECTION (scoops: 1)
                { name: "Water Ice Pop", price: 2.50, scoops: 1, isFlavorRequired: true }, 
                { name: "Cream Ice Pop", price: 3.00, scoops: 1, isFlavorRequired: true }
            ],
            "drinks": [
                { name: "Coffee", price: 2.00, isFlavorRequired: false },
                { name: "Latte", price: 4.50, isFlavorRequired: false },
                { name: "Milkshake", price: 5.50, scoops: 1, isFlavorRequired: true }, // Needs 1 flavor
                { name: "Tea", price: 1.50, isFlavorRequired: false },
                { name: "Soda", price: 2.00, isFlavorRequired: false }
            ],
            "food": [
                { name: "Crepe", price: 4.00, isFlavorRequired: false },
                { name: "French Fries", price: 3.00, isFlavorRequired: false },
                { name: "Sandwich", price: 6.00, isFlavorRequired: false },
                { name: "Pork & Fries", price: 8.50, isFlavorRequired: false }, 
                { name: "Cake", price: 5.00, isFlavorRequired: false },           
                { name: "Flan", price: 4.50, isFlavorRequired: false }            
            ]
        };
        
        // Generic flavors used for default scoops (Cones, Cups, Banana Split)
        const SCOOP_FLAVORS = [
            "Chocolate", "Vanilla", "Nut", "Strawberry", "Cookie",
            // NEW FLAVORS ADDED BELOW:
            "Oreo", "Abuelita", "Gansito", "Pinguino", "Chocoroles", 
            "Mango", "Bubblegum", "Chamoy", "Lime", "Coconut"
        ];
        
        // Generic Toppings
        const TOPPINGS = [
            "Sprinkles", "Whipped Cream", "Chocolate Sauce", "Caramel Sauce", 
            "Chopped Nuts", "Cherries", "Brownie Bites", "Oreo Crumble",
            "Mochi", "Cinnamon", "Extra Chamoy", "Tajin"
        ];

        // Specific flavor mappings for new items
        const ITEM_FLAVOR_MAPPING = {
            "Water Ice Pop": ["Grape", "Lime", "Lemon", "Watermelon", "Melon", "Strawberry"],
            "Cream Ice Pop": ["Mango", "Strawberry", "Cookie", "Vanilla", "Chocolate", "Oreo", "Nut", "Fruit"],
            "Milkshake": SCOOP_FLAVORS 
        };

        // Global State
        window.activeCart = []; // Current cart state
        window.currentCategory = 'scoops'; // Default category

        // Utility function to format currency
        window.formatCurrency = (amount) => {
            // Ensure amount is treated as a number and rounded to 2 decimal places before formatting
            const roundedAmount = Math.round(amount * 100) / 100; 
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(roundedAmount);
        };
        
        // Utility function to get a themed placeholder image - UPDATED
        const getPlaceholderUrl = (name) => {
            const base = "https://placehold.co/100x100";
            switch (name) {
                // SCOOPS
                case "Single Scoop - Waffle Cone": return `${base}/e74c3c/ffffff?text=1+CONE`;
                case "Double Scoop - Waffle Cone": return `${base}/e74c3c/ffffff?text=2+CONES`;
                case "Triple Scoop - Waffle Cone": return `${base}/e74c3c/ffffff?text=3+CONES`;
                case "Single Scoop - Cup": return `${base}/9b59b6/ffffff?text=1+CUP`;
                case "Double Scoop - Cup": return `${base}/9b59b6/ffffff?text=2+CUPS`;
                case "Triple Scoop - Cup": return `${base}/9b59b6/ffffff?text=3+CUPS`;
                case "Banana Split": return `${base}/f8f870/8e44ad?text=SPLIT`;
                // RENAMED POP ITEMS
                case "Water Ice Pop": return `${base}/3498db/ffffff?text=WATER+ICE`; 
                case "Cream Ice Pop": return `${base}/f39c12/ffffff?text=CREAM+ICE`;
                // DRINKS
                case "Coffee": return `${base}/c49a62/ffffff?text=COFFEE`;
                case "Latte": return `${base}/c49a62/ffffff?text=LATTE`;
                case "Milkshake": return `${base}/93c5fd/8e44ad?text=SHAKE`;
                case "Tea": return `${base}/94b465/ffffff?text=TEA`;
                case "Soda": return `${base}/fb7185/ffffff?text=SODA`;
                // FOOD - UPDATED
                case "Crepe": return `${base}/fecaca/8e44ad?text=CREPE`;
                case "French Fries": return `${base}/facc15/8e44ad?text=FRIES`;
                case "Sandwich": return `${base}/9ca3af/ffffff?text=SANDWICH`;
                case "Pork & Fries": return `${base}/f39c12/ffffff?text=PORK`;
                case "Cake": return `${base}/f1c40f/8e44ad?text=CAKE`;
                case "Flan": return `${base}/d35400/ffffff?text=FLAN`;
                default: return `${base}/e0e0e0/555555?text=ITEM`;
            }
        };


        // --- FIREBASE INITIALIZATION & AUTH ---

        const initFirebaseAndAuth = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    // Firebase config is missing (common when running locally without the environment).
                    // We continue but skip DB-dependent setup.
                    console.warn("Firebase configuration is missing. Cart persistence will be disabled.");
                    document.getElementById('loading-auth').textContent = 'DB Disabled';
                    document.getElementById('user-id-display').querySelector('span').textContent = 'Local Mode';
                    document.getElementById('user-id-display').classList.remove('hidden');
                    
                    // Immediately render cart display (which will show empty cart message)
                    updateCartDisplay();
                    return;
                }

                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                // Sign in with the provided custom token or anonymously
                if (window.initialAuthToken) {
                    await signInWithCustomToken(window.auth, window.initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                // Listen for authentication state changes
                onAuthStateChanged(window.auth, (user) => {
                    document.getElementById('loading-auth').classList.add('hidden');
                    const userIdDisplay = document.getElementById('user-id-display');
                    const userIdSpan = userIdDisplay.querySelector('span');

                    if (user) {
                        window.userId = user.uid;
                        userIdSpan.textContent = window.userId;
                        userIdDisplay.classList.remove('hidden');
                        setupCartListener(); // Only set up listener AFTER successful auth
                    } else {
                        window.userId = null;
                        userIdSpan.textContent = 'N/A';
                        console.error("User is not authenticated. Cannot proceed with Firestore.");
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or sign-in:", error);
                document.getElementById('loading-auth').textContent = 'Error loading Firebase.';
            }
        };

        // --- FIRESTORE FUNCTIONS ---

        const getOrderDocRef = () => {
            if (!window.db || !window.userId) {
                console.error("Database or User ID not ready. Skipping Firestore operation.");
                return null;
            }
            // Private Data Path: /artifacts/{appId}/users/{userId}/activeOrders/current
            return doc(window.db, `artifacts/${window.appId}/users/${window.userId}/activeOrders/current`);
        };

        // Listen for real-time updates to the cart
        const setupCartListener = () => {
            const docRef = getOrderDocRef();
            if (!docRef) return;

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Update local state with data from Firestore
                    const data = docSnap.data();
                    window.activeCart = data.items || [];
                    console.log("Cart updated from Firestore:", window.activeCart);
                } else {
                    // Initialize if the document doesn't exist
                    window.activeCart = [];
                    console.log("No cart found in Firestore. Initializing new cart.");
                }
                updateCartDisplay();
            }, (error) => {
                console.error("Error listening to cart changes:", error);
            });
        };

        // Save the current cart to Firestore (skipped if DB is not initialized)
        const updateCartInFirestore = async (cart) => {
            const docRef = getOrderDocRef();
            if (!docRef) {
                // In local mode, just update the display (state is kept in memory)
                updateCartDisplay();
                return; 
            }

            try {
                // We use setDoc to overwrite the single 'current' order document
                await setDoc(docRef, { items: cart });
            } catch (error) {
                console.error("Error saving cart to Firestore:", error);
            }
        };

        // --- POS RENDERING AND LOGIC ---

        // Renders the category tabs
        window.renderCategories = () => {
            const tabsContainer = document.getElementById('category-tabs');
            tabsContainer.innerHTML = '';

            Object.keys(MENU).forEach(categoryKey => {
                const button = document.createElement('button');
                button.textContent = categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1);
                button.className = `px-4 py-2 font-semibold rounded-lg transition duration-150 ${
                    categoryKey === window.currentCategory
                        ? 'color-primary text-gray-800 shadow-md'
                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                }`;
                button.onclick = () => {
                    window.currentCategory = categoryKey;
                    renderCategories(); // Re-render tabs to highlight active one
                    renderMenuItems(categoryKey);
                };
                tabsContainer.appendChild(button);
            });
        };

        // Renders the menu items for the active category
        window.renderMenuItems = (categoryKey) => {
            const itemsContainer = document.getElementById('menu-items');
            itemsContainer.innerHTML = '';
            const items = MENU[categoryKey] || [];

            if (items.length === 0) {
                itemsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center p-8">No items in this category.</p>';
                return;
            }

            items.forEach((item, index) => {
                const itemCard = document.createElement('div');
                
                // Add click behavior and data attributes to the entire card
                itemCard.className = 'bg-white border border-gray-200 rounded-xl shadow-lg hover:shadow-xl transition duration-200 cursor-pointer overflow-hidden flex flex-col justify-between transform hover:-translate-y-0.5 hover:shadow-primary/50';
                itemCard.setAttribute('data-name', item.name);
                itemCard.setAttribute('data-price', item.price);
                itemCard.setAttribute('data-scoops', item.scoops || 0);
                itemCard.setAttribute('data-flavor-required', item.isFlavorRequired);
                itemCard.setAttribute('onclick', 'addItemToCart(this)');

                itemCard.innerHTML = `
                    <div class="p-4 flex flex-col items-center text-center flex-grow justify-center">
                        <!-- Placeholder Image Added -->
                        <img src="${getPlaceholderUrl(item.name)}" alt="${item.name}" 
                            class="w-20 h-20 rounded-full mb-3 object-cover shadow-md border-2 border-primary" 
                            onerror="this.onerror=null;this.src='https://placehold.co/100x100/e0e0e0/555555?text=ITEM';" />
                        
                        <p class="text-xl font-bold text-gray-800">${item.name}</p>
                        <p class="text-sm text-gray-500 mb-2">${categoryKey.slice(0, -1).toUpperCase()}</p>
                        <p class="text-3xl font-extrabold text-primary">${formatCurrency(item.price)}</p>
                    </div>
                    <!-- REMOVED: The "Click to Add to Order" label was here -->
                `;
                itemsContainer.appendChild(itemCard);
            });
        };

        // Handles adding an item to the cart
        window.addItemToCart = (element) => { // Now accepts any element with dataset (the div)
            const { name, price, scoops, flavorRequired } = element.dataset;
            const basePrice = parseFloat(price);
            
            const item = {
                id: Date.now() + Math.random(), // Unique ID for this specific line item
                name: name,
                basePrice: basePrice,           // Store the original menu price
                price: basePrice,               // Current unit price (base + topping cost)
                toppingCost: 0,                 // Unit cost of toppings
                quantity: 1,
                scoops: parseInt(scoops),
                isFlavorRequired: flavorRequired === 'true',
                flavors: [],
                toppings: [] // Initialize toppings array
            };

            if (item.isFlavorRequired) {
                openFlavorModal(item);
            } else {
                // Non-flavored items are added directly
                window.activeCart.push(item);
                updateCartInFirestore(window.activeCart);
                showMessageBox(`Added ${item.name}!`, 'bg-blue-100 text-blue-700');
            }
        };

        // Updates the cart display and calculates totals
        window.updateCartDisplay = () => {
            const list = document.getElementById('cart-items-list');
            list.innerHTML = '';
            let subtotal = 0;

            if (window.activeCart.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 p-8">Your order is empty.</p>';
                document.getElementById('checkout-btn').disabled = true;
                document.getElementById('clear-order-btn').disabled = true;
                document.getElementById('subtotal-amount').textContent = formatCurrency(0);
                document.getElementById('total-amount').textContent = formatCurrency(0);
                return;
            }

            window.activeCart.forEach((item, index) => {
                // Calculation uses item.price, which already includes basePrice + toppingCost
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;

                const listItem = document.createElement('div');
                listItem.className = 'flex flex-col p-3 bg-white rounded-xl shadow-lg border border-gray-100'; // Made item backgrounds white with more shadow for contrast
                
                const mainInfo = document.createElement('div');
                mainInfo.className = 'flex justify-between items-start'; // Use items-start for better alignment when content is multi-line
                
                // Show topping cost explicitly
                const toppingsDisplay = item.toppings && item.toppings.length > 0
                    ? `<div class="text-xs text-green-700 font-medium mt-1">Toppings: ${item.toppings.join(', ')} (${formatCurrency(item.toppingCost)})</div>`
                    : '';

                const toppingButton = item.isFlavorRequired ? `
                    <!-- Increased size and rounded corners for touch friendliness -->
                    <button onclick="openToppingModal(${item.id})" class="text-sm px-3 py-2 rounded-xl bg-yellow-400 text-gray-800 hover:bg-yellow-500 transition duration-100 font-bold shadow-md">
                        + Topping
                    </button>
                ` : '';

                const detailsHtml = `
                    <div class="flex-grow">
                        <p class="text-lg font-bold text-gray-800">${item.name}</p>
                        <!-- Show unit price which includes topping cost -->
                        <p class="text-sm text-gray-500">${item.quantity} @ ${formatCurrency(item.price)} (Base: ${formatCurrency(item.basePrice)})</p>
                        <div class="text-xs text-gray-600 italic mt-1">${item.flavors.length > 0 ? item.flavors.join(', ') : ''}</div>
                        ${toppingsDisplay}
                    </div>
                    <div class="flex flex-col items-end space-y-2">
                        <div class="text-xl font-extrabold text-primary">${formatCurrency(itemTotal)}</div>
                        ${toppingButton}
                    </div>
                `;

                mainInfo.innerHTML = detailsHtml;
                listItem.appendChild(mainInfo);

                const actions = document.createElement('div');
                actions.className = 'flex justify-end space-x-2 mt-3 pt-3 border-t border-gray-200';
                actions.innerHTML = `
                    <!-- Increased button size and used explicit text/icons -->
                    <button onclick="decrementQuantity(${index})" class="w-10 h-10 text-xl rounded-xl bg-red-100 hover:bg-red-200 text-red-600 transition duration-100 font-extrabold shadow-sm flex items-center justify-center">
                        -
                    </button>
                    <button onclick="incrementQuantity(${index})" class="w-10 h-10 text-xl rounded-xl bg-green-100 hover:bg-green-200 text-green-600 transition duration-100 font-extrabold shadow-sm flex items-center justify-center">
                        +
                    </button>
                    <button onclick="removeItem(${index})" class="flex items-center space-x-1 px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-white transition duration-100 font-bold shadow-md">
                        <!-- Trash icon for immediate recognition -->
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        <span>Remove</span>
                    </button>
                `;
                listItem.appendChild(actions);

                list.appendChild(listItem);
            });

            // Calculate totals (Taxes are omitted for simplicity)
            document.getElementById('subtotal-amount').textContent = formatCurrency(subtotal);
            document.getElementById('total-amount').textContent = formatCurrency(subtotal); // Total = Subtotal
            document.getElementById('checkout-btn').disabled = false;
            document.getElementById('clear-order-btn').disabled = false;
        };

        // Cart manipulation logic
        window.incrementQuantity = (index) => {
            window.activeCart[index].quantity += 1;
            updateCartInFirestore(window.activeCart);
        };

        window.decrementQuantity = (index) => {
            if (window.activeCart[index].quantity > 1) {
                window.activeCart[index].quantity -= 1;
            } else {
                // If quantity drops to zero, remove the item
                window.activeCart.splice(index, 1);
            }
            updateCartInFirestore(window.activeCart);
        };

        window.removeItem = (index) => {
            window.activeCart.splice(index, 1);
            updateCartInFirestore(window.activeCart);
            showMessageBox('Item removed.', 'bg-red-100 text-red-600');
        };

        // --- FLAVOR MODAL LOGIC ---

        /**
         * Sets the currently active scoop for flavor selection and updates indicators.
         * @param {number} index - The 0-based index of the scoop.
         */
        window.selectScoop = (index) => {
            currentScoopIndex = index;
            
            // 1. Update all indicator styles
            const indicators = document.querySelectorAll('.scoop-indicator-button');
            indicators.forEach((btn, idx) => {
                btn.classList.remove('ring-4', 'ring-primary', 'shadow-xl');
                btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
                if (idx === index) {
                    btn.classList.add('ring-4', 'ring-primary', 'shadow-xl');
                    btn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                }
            });

            // 2. Clear flavor error
            document.getElementById('flavor-error').classList.add('hidden');
        };


        /**
         * Applies the selected flavor to the current scoop and advances the scoop index.
         * @param {string} flavor - The name of the flavor selected.
         */
        window.selectFlavor = (flavor) => {
            if (!itemPendingFlavor) return;

            // 1. Apply flavor to the pending array
            pendingFlavors[currentScoopIndex] = flavor;

            // 2. Update the visual indicator for the current scoop
            const currentIndicator = document.getElementById(`scoop-indicator-${currentScoopIndex}`);
            if (currentIndicator) {
                currentIndicator.innerHTML = `
                    <div class="text-sm font-semibold">Scoop ${currentScoopIndex + 1}</div>
                    <div class="text-xs italic truncate">${flavor}</div>
                `;
                currentIndicator.classList.remove('bg-gray-200', 'text-gray-600');
                currentIndicator.classList.add('bg-green-100', 'text-green-800', 'border-green-400');
            }

            // 3. Advance to the next unflavored scoop, or stay on the last one if all are done
            let nextIndex = pendingFlavors.findIndex(f => f === null);
            
            if (nextIndex === -1) {
                // All scoops flavored, stay on the last one for review
                nextIndex = itemPendingFlavor.scoops - 1; 
            }
            
            selectScoop(nextIndex);

            // Clear flavor error
            document.getElementById('flavor-error').classList.add('hidden');
        };

        // Generates the single flavor grid HTML
        const generateFlavorGrid = (flavorOptions) => {
            let html = flavorOptions.map(flavor => `
                <button 
                    type="button" 
                    data-flavor="${flavor}"
                    onclick="selectFlavor('${flavor}')"
                    class="px-2 py-4 text-sm font-medium rounded-lg border border-gray-300 bg-white hover:bg-primary/20 transition duration-150 transform hover:scale-[1.03] active:scale-[0.98] 
                           flex items-center justify-center text-center aspect-square"
                >
                    ${flavor}
                </button>
            `).join('');

            // Add the Cancel button (Red Cross)
            html += `
                <button onclick="closeFlavorModal()" class="aspect-square flex flex-col items-center justify-center text-center rounded-lg border-2 border-red-500 bg-red-100 text-red-700 hover:bg-red-200 transition duration-150 transform hover:scale-[1.03] active:scale-[0.98] shadow-md">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>
                    <span class="text-sm font-bold mt-1">CANCEL</span>
                </button>
            `;

            // Add the Add Order button (Green Mark)
            html += `
                <button onclick="confirmFlavors()" class="aspect-square flex flex-col items-center justify-center text-center rounded-lg border-2 border-green-500 bg-green-100 text-green-700 hover:bg-green-200 transition duration-150 transform hover:scale-[1.03] active:scale-[0.98] shadow-md">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                    <span class="text-sm font-bold mt-1">ADD ORDER</span>
                </button>
            `;

            return html;
        };


        window.openFlavorModal = (item) => {
            itemPendingFlavor = item;
            
            // Initialize pending flavors array with nulls
            pendingFlavors = Array(item.scoops).fill(null);
            currentScoopIndex = 0;

            document.getElementById('flavor-modal-item-name').textContent = `${item.name} (${item.scoops} Scoops)`;
            document.getElementById('flavor-error').classList.add('hidden');
            
            const indicatorsContainer = document.getElementById('scoop-indicators');
            const gridContainer = document.getElementById('single-flavor-grid');
            
            indicatorsContainer.innerHTML = '';
            
            // 1. Render Scoop Indicators
            for (let i = 0; i < item.scoops; i++) {
                const indicatorButton = document.createElement('button');
                indicatorButton.setAttribute('id', `scoop-indicator-${i}`);
                indicatorButton.setAttribute('data-scoop-index', i);
                indicatorButton.setAttribute('onclick', `selectScoop(${i})`);
                indicatorButton.className = 'scoop-indicator-button p-2 w-28 h-16 rounded-lg border-2 text-center transition duration-150 flex flex-col justify-center items-center bg-gray-200 text-gray-600 hover:bg-gray-300 border-gray-300';
                indicatorButton.innerHTML = `
                    <div class="text-sm font-semibold">Scoop ${i + 1}</div>
                    <div class="text-xs italic text-gray-400">Not Set</div>
                `;
                indicatorsContainer.appendChild(indicatorButton);
            }
            
            // 2. Render Single Flavor Grid (including the action buttons)
            const flavorOptions = ITEM_FLAVOR_MAPPING[item.name] || SCOOP_FLAVORS;
            gridContainer.innerHTML = generateFlavorGrid(flavorOptions);

            // 3. Set initial active scoop (the first one)
            selectScoop(0);
            
            document.getElementById('flavor-modal').classList.remove('hidden');
        };

        window.closeFlavorModal = () => {
            document.getElementById('flavor-modal').classList.add('hidden');
            itemPendingFlavor = null;
        };

        window.confirmFlavors = () => {
            if (!itemPendingFlavor) return;

            // Check if all flavors are selected (no nulls in pendingFlavors)
            const allSelected = pendingFlavors.every(flavor => flavor !== null);

            if (!allSelected) {
                document.getElementById('flavor-error').textContent = "Please select a flavor for all scoops.";
                document.getElementById('flavor-error').classList.remove('hidden');
                // Highlight the first unflavored scoop
                const firstUnflavoredIndex = pendingFlavors.findIndex(f => f === null);
                if (firstUnflavoredIndex !== -1) {
                     selectScoop(firstUnflavoredIndex);
                }
                return;
            }

            // All flavors selected, update the item and add it to the cart
            itemPendingFlavor.flavors = pendingFlavors;
            window.activeCart.push(itemPendingFlavor);
            updateCartInFirestore(window.activeCart);
            closeFlavorModal();
            showMessageBox(`Added ${itemPendingFlavor.name} with ${itemPendingFlavor.scoops} flavors!`, 'bg-blue-100 text-blue-700');
        };


        // --- TOPPING MODAL LOGIC ---

        const generateToppingGrid = (currentToppings) => {
            return TOPPINGS.map(topping => {
                const isSelected = currentToppings.includes(topping);
                return `
                    <button 
                        type="button" 
                        data-topping="${topping}"
                        onclick="toggleTopping(event, '${topping}')"
                        class="p-3 text-sm font-medium rounded-lg border border-gray-300 transition duration-150 transform hover:scale-[1.03] active:scale-[0.98] 
                               ${isSelected ? 'bg-indigo-200 text-indigo-800 border-indigo-400 shadow-md' : 'bg-white hover:bg-gray-100'}
                               flex items-center justify-center text-center aspect-square"
                    >
                        ${topping}
                    </button>
                `;
            }).join('');
        };
        
        window.toggleTopping = (event, topping) => {
            const index = pendingToppings.indexOf(topping);
            const button = event.currentTarget;

            if (index > -1) {
                // Remove topping
                pendingToppings.splice(index, 1);
                button.classList.remove('bg-indigo-200', 'text-indigo-800', 'border-indigo-400', 'shadow-md');
                button.classList.add('bg-white', 'hover:bg-gray-100');
            } else {
                // Add topping
                pendingToppings.push(topping);
                button.classList.add('bg-indigo-200', 'text-indigo-800', 'border-indigo-400', 'shadow-md');
                button.classList.remove('bg-white', 'hover:bg-gray-100');
            }
        };


        window.openToppingModal = (itemId) => {
            const item = window.activeCart.find(i => i.id === itemId);
            if (!item) {
                showMessageBox("Error: Item not found in cart.", 'bg-red-100 text-red-600');
                return;
            }

            itemPendingToppingsId = itemId;
            
            // Initialize pending toppings with the item's current toppings (deep copy)
            pendingToppings = [...item.toppings]; 

            document.getElementById('topping-modal-item-name').textContent = item.name;
            
            const gridContainer = document.getElementById('topping-selection-grid');
            gridContainer.innerHTML = generateToppingGrid(pendingToppings);
            
            document.getElementById('topping-modal').classList.remove('hidden');
        };

        window.closeToppingModal = () => {
            document.getElementById('topping-modal').classList.add('hidden');
            itemPendingToppingsId = null;
        };
        
        window.confirmToppings = () => {
            const itemIndex = window.activeCart.findIndex(item => item.id === itemPendingToppingsId);
            if (itemIndex === -1) {
                showMessageBox("Error confirming toppings: Item not found.", 'bg-red-100 text-red-600');
                closeToppingModal();
                return;
            }
            
            // Calculate topping cost: $0.50 per topping
            const toppingCost = pendingToppings.length * TOPPING_PRICE;
            
            // Update the actual item in the cart
            window.activeCart[itemIndex].toppings = pendingToppings;
            window.activeCart[itemIndex].toppingCost = toppingCost;
            
            // Update item price (unit price) = basePrice + toppingCost
            window.activeCart[itemIndex].price = window.activeCart[itemIndex].basePrice + toppingCost;
            
            updateCartInFirestore(window.activeCart);
            
            closeToppingModal();
            showMessageBox('Toppings updated successfully!', 'bg-indigo-100 text-indigo-700');
        };


        // --- ORDER ACTIONS AND UTILITIES ---

        window.clearOrder = () => {
            if (window.activeCart.length > 0) {
                window.activeCart = [];
                updateCartInFirestore(window.activeCart);
                showMessageBox('Order cleared.', 'bg-orange-100 text-orange-700');
            }
        };

        window.checkout = () => {
            if (window.activeCart.length > 0) {
                const total = window.activeCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                showMessageBox(`Checkout complete! Total: ${formatCurrency(total)}. Order is cleared.`, 'bg-green-100 text-green-700');
                // In a real POS, this would save the order to a 'history' collection before clearing.
                window.activeCart = [];
                updateCartInFirestore(window.activeCart);
            } else {
                showMessageBox('The cart is empty!', 'bg-yellow-100 text-yellow-700');
            }
        };
        
        // Custom message box instead of alert()
        window.showMessageBox = (message, className) => {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `mt-4 p-3 rounded-lg text-center font-semibold transition-opacity duration-300 ${className}`;
            box.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('hidden');
                box.classList.remove(className); // Clean up classes
            }, 3000);
        };
        
        // --- CLOCK AND DATE/TIME LOGIC (NEW) ---
        const updateClock = () => {
            const now = new Date();
            
            // Format date: Sat, Nov 22, 2025
            const dateOptions = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', dateOptions);

            // Format time: 7:26:45 PM
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            const timeString = now.toLocaleTimeString('en-US', timeOptions);

            const displayElement = document.getElementById('date-time-display');
            if (displayElement) {
                displayElement.innerHTML = `
                    <div class="text-lg font-bold text-gray-800">${timeString}</div>
                    <div class="text-xs text-gray-500">${dateString}</div>
                `;
            }
        };


        // --- APPLICATION INITIALIZATION ---
        
        // 1. Render static content immediately (Categories and Menu Items)
        // This fixes the issue of the menu not loading locally while waiting for Firebase auth.
        renderCategories();
        renderMenuItems(window.currentCategory);
        
        // 2. Start the clock
        updateClock();
        setInterval(updateClock, 1000);
        
        // 3. Initialize Firebase and handle cart persistence asynchronously
        initFirebaseAndAuth();
    </script>
    <!-- === JAVASCRIPT LOGIC SECTION END === -->
</body>
</html>